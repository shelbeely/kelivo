# Generative UI Feature Documentation

## Overview

The Generative UI feature allows the Kelivo app to render UI screens based on a JSON schema generated by an LLM. The LLM acts as a "planner" that outputs structured JSON UI definitions, while the app acts as a "renderer" that transforms those definitions into real Material Design 3 Expressive components.

**Key Principles:**
- The LLM only emits structured JSON matching a strict schema
- No runtime code execution (`eval`) from LLM output
- All LLM output goes through schema validation before rendering

## Architecture

```
┌─────────────┐      JSON Schema      ┌─────────────────┐
│  LLM API    │ ───────────────────>  │  Schema Parser  │
│  (Planner)  │                       │  + Validator    │
└─────────────┘                       └────────┬────────┘
                                               │
                                               │ Validated Screen
                                               ▼
                                      ┌─────────────────┐
                                      │   Renderer      │
                                      │ (M3 Expressive) │
                                      └────────┬────────┘
                                               │
                                               │ Flutter Widgets
                                               ▼
                                      ┌─────────────────┐
                                      │   UI Display    │
                                      └─────────────────┘
```

## Schema Definition

The schema is defined in `lib/generative_ui/schema.dart`.

### Core Types

#### Screen

```dart
class Screen {
  final String screenId;
  final ScreenRole? role;          // hero_screen | secondary_screen
  final Tone? tone;                // expressive | standard
  final MotionScheme? motionScheme;// expressive | standard | reduced
  final ColorMode? colorMode;      // brand | dynamic
  final List<Block> blocks;
}
```

#### Block (Union Type)

The `Block` type is a sealed class with the following variants:

- **HeroBlock**: Large header section with headline, subhead, and optional icon
- **CardBlock**: Container with headline, body content, and action buttons
- **TextBlock**: Simple text content with typography variants
- **ListBlock**: Vertical list of items
- **ButtonBlock**: Interactive button with role-based styling

#### Common Expressive Metadata

All blocks support these expressive properties:

```dart
Emphasis? emphasis;  // hero | primary | secondary | tertiary
Surface? surface;    // surface | surfaceVariant | primary | secondary | tertiary
Motion? motion;      // expressive | standard | reduced
```

## Renderer Mapping

The renderer (`lib/generative_ui/renderer.dart`) maps expressive metadata to Material 3 tokens:

### Emphasis → Visual Properties

| Emphasis  | Shape Radius | Elevation | Typography   | Padding |
|-----------|--------------|-----------|--------------|---------|
| hero      | 28           | 0         | displayMedium| 24      |
| primary   | 20           | 2         | headlineSmall| 20      |
| secondary | 16           | 1         | titleMedium  | 16      |
| tertiary  | 12           | 0         | bodyLarge    | 12      |

### Surface → Color Roles

| Surface        | Background Color         | On-Surface Color       |
|----------------|--------------------------|------------------------|
| surface        | colorScheme.surface      | colorScheme.onSurface  |
| surfaceVariant | colorScheme.surfaceVariant| colorScheme.onSurfaceVariant|
| primary        | colorScheme.primaryContainer| colorScheme.onPrimaryContainer|
| secondary      | colorScheme.secondaryContainer| colorScheme.onSecondaryContainer|
| tertiary       | colorScheme.tertiaryContainer| colorScheme.onTertiaryContainer|

### Motion → Animation Properties

| Motion     | Duration  | Easing              |
|------------|-----------|---------------------|
| expressive | 400ms     | Curves.easeOutBack  |
| standard   | 250ms     | Curves.easeInOut    |
| reduced    | 100ms     | Curves.linear       |

### Button Roles

| Role             | Button Style       | Position          |
|------------------|--------------------|--------------------|
| primary_action   | FilledButton       | Edge-hugging      |
| secondary_action | OutlinedButton     | Inline            |
| destructive      | FilledButton (error)| Inline           |

### Button Layouts

| Layout       | Behavior                                      |
|--------------|-----------------------------------------------|
| edge_hugging | Bottom-aligned, full-width on mobile          |
| inline       | Normal flow, auto-width                       |
| toolbar      | Arranged horizontally in app bar area         |

## LLM Integration

The LLM service (`lib/generative_ui/llm_service.dart`) handles communication with the LLM.

### System Prompt Guidelines

The system prompt instructs the LLM:

1. Output **only JSON** according to the `Screen` and `Block` types
2. Use a small number of high-emphasis components:
   - At most 1 `hero` block per screen with `emphasis: "hero"`
   - Exactly 1 primary action button per main screen with `role: "primary_action"`
3. Use emphasis levels appropriately:
   - `hero` for the main hero section
   - `primary` for key content cards
   - `secondary` or `tertiary` for supporting content
4. Use `layout: "edge_hugging"` for main primary action on mobile screens
5. Respect `motionScheme` and reduced motion settings

### Validation

All LLM output is validated before rendering:
- JSON parsing with error handling
- Type validation for all fields
- Clamping/rejection of invalid values
- Unknown block types are filtered out

## API

### GenerativeScreen Widget

```dart
GenerativeScreen(
  spec: Screen,           // The screen specification
  onAction: (action) {},  // Callback when button is pressed
  isLoading: false,       // Show loading state
  error: null,            // Show error state
)
```

### GenerativeUIService

```dart
final service = GenerativeUIService(providerConfig);

// Generate a screen from context
final screen = await service.generateScreen(
  context: appContext,     // App state relevant to the screen
  userContext: userCtx,    // Device type, theme, reduced motion
  previousScreen: prev,    // For incremental updates (optional)
);
```

## Extending the Schema

To add a new block type:

1. Add the new variant to the `Block` sealed class in `schema.dart`
2. Add serialization/deserialization in `_parseBlock()`
3. Add rendering logic in `_BlockRenderer` in `renderer.dart`
4. Document the new block type in this file

## Demo Feature

The demo screen is available at `lib/features/generative_ui/pages/generative_ui_demo_page.dart`.

### How to Test

1. Navigate to Settings → Generative UI Demo
2. The screen will gather real app data (user info, recent chats, etc.)
3. Request an LLM to generate a dashboard UI
4. Interact with buttons to trigger updates

### Feature Flag

The feature can be enabled/disabled via `SettingsProvider.generativeUIEnabled`.

## Security Considerations

- No runtime `eval()` of LLM output
- All JSON is parsed and validated against the strict schema
- Unknown fields are ignored, unknown block types are filtered
- API keys are never exposed to the LLM output

## Files Added/Changed

| File | Purpose |
|------|---------|
| `lib/generative_ui/schema.dart` | Schema type definitions |
| `lib/generative_ui/renderer.dart` | M3 Expressive renderer |
| `lib/generative_ui/llm_service.dart` | LLM integration |
| `lib/features/generative_ui/pages/generative_ui_demo_page.dart` | Demo screen |
| `docs/generative-ui-notes.md` | This documentation |
